<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Two-factor Authentication</title>
    <style>
        :root{
          --bg:#f6f8fb;
          --card:#ffffff;
          --accent:#0069ff;
          --muted:#6b7280;
          --danger:#e03131;
          --shadow: 0 6px 18px rgba(11,15,29,0.06);
          --radius:12px;
          --input-size:56px;
        }
        html,body{height:100%}
        body{
          margin:0;
          font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
          background: linear-gradient(180deg,#eef2ff 0%,var(--bg) 100%);
          display:flex;
          align-items:center;
          justify-content:center;
          padding:24px;
          color:#0b0f1d;
        }
        .card{
          width:100%;
          max-width:420px;
          background:var(--card);
          border-radius:var(--radius);
          box-shadow:var(--shadow);
          padding:28px;
        }
        h1{
          margin:0 0 10px 0;
          font-size:20px;
          color:#0b1220;
        }
        p.lead{
          margin:0 0 18px 0;
          color:var(--muted);
          font-size:14px;
        }

        .error{
          background:#fff5f5;
          color:var(--danger);
          border:1px solid rgba(224,49,49,0.12);
          padding:10px 12px;
          border-radius:8px;
          margin-bottom:14px;
          font-size:13px;
        }

        .otp-row{
          display:flex;
          gap:10px;
          justify-content:center;
          margin:18px 0 6px 0;
        }
        .otp-input{
          width:var(--input-size);
          height:var(--input-size);
          text-align:center;
          font-size:22px;
          border-radius:10px;
          border:1px solid #e6e9ef;
          outline: none;
          background: linear-gradient(#ffffff,#fbfdff);
          box-shadow: 0 1px 0 rgba(11,15,29,0.02);
          transition: border-color .12s, box-shadow .12s, transform .06s;
        }
        .otp-input:focus{
          border-color: var(--accent);
          box-shadow: 0 6px 18px rgba(2,6,23,0.06);
          transform: translateY(-1px);
        }
        .otp-input::-webkit-outer-spin-button,
        .otp-input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
        .controls{
          display:flex;
          align-items:center;
          justify-content:space-between;
          gap:12px;
          margin-top:12px;
        }
        .muted { color:var(--muted); font-size:13px }
        .btn {
          display:inline-flex;
          align-items:center;
          gap:8px;
          background:var(--accent);
          color:white;
          border:none;
          padding:10px 14px;
          border-radius:10px;
          cursor:pointer;
          font-weight:600;
          font-size:14px;
        }
        .btn[disabled] { opacity:.6; cursor:default }
        .link-btn {
          background:transparent;
          color:var(--accent);
          border:none;
          cursor:pointer;
          padding:6px;
          font-weight:600;
          font-size:13px;
        }
        .small { font-size:12px; color:var(--muted) }

        @media (max-width:420px){
          .otp-row{gap:8px}
          :root{--input-size:48px}
        }
    </style>
</head>
<body>
<div class="card" role="main">
    <h1>Enter your authentication code</h1>
    <p class="lead">Please enter the 6-digit code from your authenticator app.</p>

    <!-- error placeholder -->
    {{#error}}
        <div class="error" role="alert">{{errorMessage}}</div>
    {{/error}}

    <form id="otpForm" method="POST" action="/otp-check" autocomplete="off" novalidate>
        <!-- optional redirect -->
        <input type="hidden" name="redirect" value="{{redirect}}" />

        <!-- visible segmented inputs -->
        <div class="otp-row" aria-hidden="false">
            <input inputmode="numeric" pattern="[0-9]*" inputmode="numeric"
                   class="otp-input" id="otp-1" maxlength="1" aria-label="Digit 1" />
            <input inputmode="numeric" pattern="[0-9]*"
                   class="otp-input" id="otp-2" maxlength="1" aria-label="Digit 2" />
            <input inputmode="numeric" pattern="[0-9]*"
                   class="otp-input" id="otp-3" maxlength="1" aria-label="Digit 3" />
            <input inputmode="numeric" pattern="[0-9]*"
                   class="otp-input" id="otp-4" maxlength="1" aria-label="Digit 4" />
            <input inputmode="numeric" pattern="[0-9]*"
                   class="otp-input" id="otp-5" maxlength="1" aria-label="Digit 5" />
            <input inputmode="numeric" pattern="[0-9]*"
                   class="otp-input" id="otp-6" maxlength="1" aria-label="Digit 6" />
        </div>

        <!-- hidden fallback input used to submit combined value if JS disabled -->
        <noscript>
            <input type="text" name="otp" maxlength="6" pattern="\d{6}" required placeholder="Enter 6-digit code" />
        </noscript>

        <!-- JS will fill this before submit -->
        <input type="hidden" name="otp" id="otpHidden" />

        <div class="controls">
<!--            <div>-->
<!--                <span class="muted">Didn't receive a code?</span>-->
<!--                <button type="button" id="resendBtn" class="link-btn">Resend</button>-->
<!--                <span class="small" id="countdown" aria-live="polite"></span>-->
<!--            </div>-->

            <div>
                <button type="submit" class="btn" id="submitBtn">Verify</button>
            </div>
        </div>
    </form>
</div>

<script>
    (function(){
      const inputs = Array.from(document.querySelectorAll('.otp-input'));
      const hidden = document.getElementById('otpHidden');
      const form = document.getElementById('otpForm');
      const resendBtn = document.getElementById('resendBtn');
      const countdownEl = document.getElementById('countdown');
      const submitBtn = document.getElementById('submitBtn');

      // Focus first input
      inputs[0].focus();

      // Handle paste of full code
      inputs[0].addEventListener('paste', (e) => {
        e.preventDefault();
        const paste = (e.clipboardData || window.clipboardData).getData('text').trim();
        const digits = paste.replace(/\D/g,'').slice(0,6).split('');
        digits.forEach((d,i) => { if(inputs[i]) inputs[i].value = d; });
        if (digits.length === 6) inputs[5].focus();
      });

      // Key handling and auto-advance/backspace
      inputs.forEach((input, idx) => {
        input.addEventListener('input', (e) => {
          const v = input.value.replace(/\D/g,'');
          input.value = v;
          if (v && idx < inputs.length -1) {
            inputs[idx+1].focus();
            inputs[idx+1].select();
          }
          updateSubmitState();
        });
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace' && !input.value && idx > 0) {
            inputs[idx-1].focus();
            inputs[idx-1].value = '';
            e.preventDefault();
          } else if (e.key === 'ArrowLeft' && idx > 0) {
            inputs[idx-1].focus();
          } else if (e.key === 'ArrowRight' && idx < inputs.length-1) {
            inputs[idx+1].focus();
          } else if (e.key === 'Enter') {
            e.preventDefault();
            attemptSubmit();
          }
        });
      });

      // Combine inputs into hidden field before submit
      form.addEventListener('submit', (e) => {
        if (!attemptSubmit()) {
          e.preventDefault();
        }
      });

      function attemptSubmit(){
        const code = inputs.map(i => i.value || '').join('');
        hidden.value = code;
        if (/^\d{6}$/.test(code)) {
          submitBtn.disabled = true;
          return true; // allow submit
        } else {
          // show inline error (simple)
          flashError("Please enter a 6-digit code");
          return false;
        }
      }

      // simple flash error (client-side)
      function flashError(msg){
        let el = document.querySelector('.error');
        if (!el) {
          el = document.createElement('div');
          el.className = 'error';
          el.setAttribute('role','alert');
          form.parentElement.insertBefore(el, form);
        }
        el.textContent = msg;
        setTimeout(()=> { el && el.remove(); }, 3500);
      }

      function updateSubmitState(){
        const code = inputs.map(i => i.value||'').join('');
        submitBtn.disabled = !/^\d{6}$/.test(code);
      }

      // Resend handling with cooldown
      let cooldown = 30; // seconds
      let timer = null;
      function startCooldown(){
        resendBtn.disabled = true;
        let remaining = cooldown;
        countdownEl.textContent = ` (${remaining}s)`;
        timer = setInterval(() => {
          remaining--;
          countdownEl.textContent = remaining > 0 ? ` (${remaining}s)` : '';
          if (remaining <= 0) {
            clearInterval(timer);
            resendBtn.disabled = false;
            countdownEl.textContent = '';
          }
        }, 1000);
      }

      resendBtn.addEventListener('click', () => {
        // do an AJAX call to request a new code (optional). Replace URL as needed.
        resendBtn.disabled = true;
        fetch('/oauth/totp/resend', { method: 'POST', headers: { 'Content-Type': 'application/json' }})
          .then(resp => {
            if (!resp.ok) throw new Error('Unable to resend code');
            startCooldown();
          })
          .catch(() => {
            flashError('Could not resend code. Try again later.');
            resendBtn.disabled = false;
          });
      });

      // Start initial cooldown if you want (comment out if not)
      // startCooldown();

      // Allow numeric keypad on mobile and disable autocomplete
      inputs.forEach(i => i.setAttribute('autocomplete', 'one-time-code'));
    })();
</script>
</body>
</html>
